<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Auth System</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/profile.css}">
</head>
<body>
    <nav class="nav-bar">
        <div class="nav-content">
            <a href="/" class="nav-brand">AuthSystem</a>
            <div class="nav-links">
                <a href="/">Dashboard</a>
                <button onclick="logout()" class="btn btn-secondary" style="padding: 5px 15px; font-size: 14px; border: none;">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container profile-container">
        <div class="card">
            <div class="card-body">
                <div id="alertContainer"></div>

                <div class="profile-header">
                    <div class="profile-avatar" th:if="${user}" th:text="${user.name?.substring(0,1)}">
                        U
                    </div>
                    <h2 id="displayName" th:if="${user}" th:text="${user.name}">User Name</h2>
                    <p th:if="${user}" th:text="${user.email}">user@example.com</p>
                </div>

                <div class="profile-section">
                    <h3 class="section-title">Update Details</h3>

                    <form id="updateProfileForm" class="edit-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="name">Full Name</label>
                                <input type="text" id="name" name="name" class="form-control" 
                                       th:value="${user?.name}" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone Number (Optional)</label>
                                <input type="tel" id="phone" name="phone" class="form-control" 
                                       th:value="${user?.phone}">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="newPassword">New Password (Leave blank to keep current)</label>
                            <input type="password" id="newPassword" name="newPassword" class="form-control" 
                                   placeholder="Enter new password (min 6 characters)">
                        </div>
                        
                        <div class="form-group">
                            <label for="bio">Bio (Optional)</label>
                            <textarea id="bio" name="bio" class="form-control bio-textarea" 
                                      th:text="${user?.bio}"></textarea>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                            <button type="button" onclick="window.location.reload()" class="btn btn-secondary">Reset</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const alertContainer = document.getElementById('alertContainer');

        function showAlert(message, type) {
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertContainer.innerHTML = '', 5000);
        }

        // --- Profile Form Submission Logic ---
        document.getElementById('updateProfileForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Collect all data from the form fields
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const bio = document.getElementById('bio').value;
            const newPassword = document.getElementById('newPassword').value; 
            
            // Basic password validation
            if (newPassword.length > 0 && newPassword.length < 6) {
                showAlert('Password must be at least 6 characters long.', 'error');
                return;
            }

            // Build the request body for the DTO
            const updateData = {
                name: name,
                phone: phone,
                bio: bio,
                // The DTO field is named 'password'
                password: newPassword 
            };
            
            const btn = this.querySelector('button[type="submit"]');
            btn.innerHTML = '<div class="loading"></div> Updating...';
            btn.disabled = true;

            try {
                const response = await fetch('/profile/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('Profile updated successfully!', 'success');
                    
                    // Update displayed name dynamically
                    if (result.data) {
                        document.getElementById('displayName').textContent = result.data.name;
                        document.querySelector('.profile-avatar').textContent = result.data.name.substring(0,1);
                    }

                    // IMPORTANT: Clear the password field after successful update
                    document.getElementById('newPassword').value = ''; 

                } else {
                    showAlert(result.message || 'Profile update failed.', 'error');
                }
            } catch (error) {
                showAlert('An unexpected error occurred during update.', 'error');
            } finally {
                btn.innerHTML = 'Update Profile';
                btn.disabled = false;
            }
        });

        // Logout function from profile.html
        async function logout() {
            try {
                // Fetch to the /api/logout endpoint
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login?logout=true';
            } catch (error) {
                window.location.href = '/login?logout=true'; // Fallback redirect
            }
        }
    </script>
</body>
</html>